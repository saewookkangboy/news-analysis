# API 호출 디버깅 강화 및 버그 수정

## 문제점
API 키가 설정되어 있음에도 불구하고 "기본 분석 모드"로 실행되는 문제가 발생했습니다.

## 원인 분석
1. API 키 확인은 성공하지만 실제 API 호출 시 예외가 발생
2. 예외가 발생하면 `_analyze_basic`으로 fallback
3. 상세한 에러 로그가 부족하여 문제 진단이 어려움

## 해결 방법

### 1. 상세한 로깅 추가

**변경 사항**:
- API 호출 시작/완료 시점에 명확한 로그 추가
- API 키 확인 상태 상세 로깅
- 예외 발생 시 상세한 스택 트레이스 로깅
- API 응답 정보 로깅 (토큰 사용량 등)

**예시**:
```python
logger.info("=" * 60)
logger.info("🚀 OpenAI API 호출 시작")
logger.info(f"API 키 확인: ✅ (길이: {len(api_key)} 문자)")
logger.info(f"모델: {settings.OPENAI_MODEL}")
logger.info("=" * 60)
```

### 2. 예외 처리 개선

**변경 사항**:
- `ValueError` (API 키 오류)는 그대로 전파하여 재시도하지 않음
- 다른 예외는 상세한 로그와 함께 처리
- ImportError는 명확한 메시지와 함께 전파

**이전**:
```python
except Exception as e:
    logger.error(f"OpenAI API 호출 실패: {e}")
    return _analyze_basic(...)
```

**수정 후**:
```python
except ValueError as ve:
    # API 키 관련 오류는 그대로 전파
    raise
except Exception as e:
    logger.error("=" * 60)
    logger.error(f"❌ OpenAI API 호출 실패: {type(e).__name__}: {e}")
    import traceback
    logger.error(f"상세 스택 트레이스:\n{traceback.format_exc()}")
    logger.error("=" * 60)
    raise ValueError(f"OpenAI API 호출 실패: {str(e)}")
```

### 3. 수정된 파일

#### backend/services/target_analyzer.py

**주요 변경 사항**:

1. **`analyze_target()` 함수**:
   - API 호출 시작/완료 시 상세 로깅 추가
   - 예외 처리 개선 (ValueError 분리)
   - 스택 트레이스 로깅 추가

2. **`_analyze_with_openai()` 함수**:
   - API 호출 전/후 상세 로깅 추가
   - 응답 정보 로깅 (ID, 토큰 사용량)
   - 예외 처리 개선

3. **`_analyze_with_gemini()` 함수**:
   - API 호출 전/후 상세 로깅 추가
   - 예외 처리 개선

## 검증 방법

### Vercel 배포 후 로그 확인

배포 후 Vercel 로그에서 다음을 확인하세요:

1. **API 키 확인 로그**:
   ```
   ============================================================
   API 키 상태 확인 (상세)
   os.getenv('OPENAI_API_KEY'): ✅ 설정됨
   최종 openai_key: ✅ 설정됨
   ============================================================
   ```

2. **API 호출 시작 로그**:
   ```
   ============================================================
   🚀 OpenAI API 호출 시작
   API 키 확인: ✅ (길이: 167 문자)
   모델: gpt-4o-mini
   ============================================================
   ```

3. **API 호출 완료 로그**:
   ```
   ============================================================
   ✅ OpenAI API 응답 수신 완료
   응답 ID: chatcmpl-...
   사용된 토큰: 1234
   ============================================================
   ```

4. **에러 발생 시**:
   ```
   ============================================================
   ❌ OpenAI API 호출 실패: APIError: ...
   상세 스택 트레이스:
   [전체 스택 트레이스]
   ============================================================
   ```

## 다음 단계

1. **재배포**
   - 수정 사항 반영 후 Vercel에 재배포

2. **로그 확인**
   - 배포 후 Vercel 로그에서 상세한 API 호출 로그 확인
   - 에러가 발생하면 상세한 스택 트레이스를 확인하여 원인 파악

3. **테스트**
   - 실제 분석 요청을 보내고 로그 확인
   - API가 정상적으로 호출되는지 확인
   - 기본 분석 모드로 fallback되지 않는지 확인

## 예상 결과

수정 후에는:
- ✅ API 키가 정상적으로 인식됨
- ✅ 실제 AI API가 호출됨
- ✅ 상세한 로그로 문제 진단 가능
- ✅ "기본 분석 모드" 메시지가 나오지 않음
- ✅ 실제 AI 분석 결과가 반환됨
